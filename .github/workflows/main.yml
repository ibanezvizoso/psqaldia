import os
import requests
import google.generativeai as genai
import json
import re
from datetime import datetime

# --- CONFIGURACIÓN PUBMED ---
PUBMED_SEARCH_URL = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi"
PUBMED_FETCH_URL = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi"

# Buscamos específicamente en revistas de alto impacto (Lancet, JAMA, etc.)
QUERY = "(JAMA Psychiatry[Journal] OR Lancet Psychiatry[Journal] OR American Journal of Psychiatry[Journal]) AND (last 7 days[dp])"

def get_recent_pubmed_articles():
    params = {
        "db": "pubmed",
        "term": QUERY,
        "retmax": 3,
        "sort": "pub date",
        "retmode": "json"
    }
    r = requests.get(PUBMED_SEARCH_URL, params=params)
    return r.json().get("esearchresult", {}).get("idlist", [])

def get_article_details(id_list):
    if not id_list: return []
    params = {"db": "pubmed", "id": ",".join(id_list), "retmode": "json"}
    r = requests.get(PUBMED_FETCH_URL, params=params)
    data = r.json()
    return [{"title": data["result"][id]["title"], "journal": data["result"][id]["fulljournalname"]} for id in id_list]

# --- PROCESO PRINCIPAL ---
try:
    # 1. Obtener datos reales
    ids = get_recent_pubmed_articles()
    if not ids: # Si no hay en las top, buscamos psiquiatría general
        QUERY = "psychiatry[Journal] AND (last 7 days[dp])"
        ids = get_recent_pubmed_articles()
    
    articles = get_article_details(ids)
    contexto = "\n".join([f"- {a['title']} ({a['journal']})" for a in articles])

    # 2. Configurar Gemini (1.5 Flash para evitar errores de cuota)
    genai.configure(api_key=os.environ.get("GEMINI_API_KEY"))
    model = genai.GenerativeModel("gemini-1.5-flash")

    prompt = f"""
    Eres un psiquiatra académico. Resume estos artículos REALES de PubMed para un boletín profesional.
    
    ARTÍCULOS ENCONTRADOS:
    {contexto}

    REQUISITOS:
    - Traduce los títulos y redacta un resumen técnico/clínico serio para cada uno.
    - Usa un tono profesional.
    
    Responde ÚNICAMENTE con este formato JSON:
    {{
      "fecha": "AUTO",
      "titulo": "Boletín semanal experimental",
      "resumen": "Boletín experimental no supervisado. Selección de artículos reales de PubMed:\\n\\n1. [Resumen 1]\\n2. [Resumen 2]\\n3. [Resumen 3]",
      "categoria": "BOLETINES",
      "link": "https://pubmed.ncbi.nlm.nih.gov/"
    }}
    """

    response = model.generate_content(prompt)
    
    # Limpiar y guardar
    match = re.search(r'\{.*\}', response.text, re.DOTALL)
    data = json.loads(match.group(0))
    data["fecha"] = datetime.now().strftime("%d/%m/%Y")

    with open("boletin.json", "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    print("✅ Boletín generado con éxito.")

except Exception as e:
    # Fallback si falla la red o la IA
    error_data = {
        "fecha": datetime.now().strftime("%d/%m/%Y"),
        "titulo": "Boletín semanal experimental",
        "resumen": f"Error en la actualización: {str(e)}",
        "categoria": "BOLETINES",
        "link": "#"
    }
    with open("boletin.json", "w", encoding="utf-8") as f:
        json.dump(error_data, f, ensure_ascii=False, indent=2)
    print(f"❌ Fallo: {str(e)}")
